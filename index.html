<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faisal-Durood Counter</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAG0JD5hIk6w_zq1KNbm4HnXxajUxMk5l4",
            authDomain: "faisal-durood.firebaseapp.com",
            projectId: "faisal-durood",
            storageBucket: "faisal-durood.firebasestorage.app",
            messagingSenderId: "901424587968",
            appId: "1:901424587968:web:3fc0dea15c41f46f9af925",
            databaseURL: "https://faisal-durood-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const counterRef = ref(db, 'stats');

        function getCurrentMonthKey() {
            const now = new Date();
            return `${now.getFullYear()}-${now.getMonth() + 1}`;
        }

        function getMonthName() {
            return new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
        }

        function updateDisplay(data) {
            const currentTotal = data.total || 0;
            const monthlyTarget = data.monthlyTarget || 100000;
            const remaining = monthlyTarget - currentTotal;

            document.getElementById('main-counter').innerText = currentTotal.toLocaleString();
            document.getElementById('remaining-target').innerText = (remaining > 0 ? remaining : 0).toLocaleString();
            document.getElementById('month-label').innerText = getMonthName();
        }

        onValue(counterRef, (snapshot) => {
            const data = snapshot.val();
            const currentMonthKey = getCurrentMonthKey();

            if (!data) {
                set(counterRef, { total: 0, monthlyTarget: 100000, monthKey: currentMonthKey });
            } else if (data.monthKey !== currentMonthKey) {
                const leftover = Math.max(0, (data.monthlyTarget || 100000) - (data.total || 0));
                set(counterRef, {
                    total: 0,
                    monthlyTarget: 100000 + leftover,
                    monthKey: currentMonthKey
                });
            } else {
                updateDisplay(data);
            }
        });

        window.addCount = function(amt) {
            runTransaction(ref(db, 'stats/total'), (current) => (current || 0) + amt);
        };

        window.addManual = function() {
            const val = parseInt(document.getElementById('manualNum').value);
            if (val > 0) {
                addCount(val);
                document.getElementById('manualNum').value = "";
            }
        };
    </script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        .header-box { background: #e8f5e9; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #c8e6c9; }
        #month-label { color: #2e7d32; font-weight: bold; font-size: 0.85rem; letter-spacing: 1px; }
        #main-counter { font-size: 4.5rem; color: var(--primary); font-weight: 800; margin: 15px 0; }
        .target-remaining { color: #d32f2f; font-size: 1.1rem; font-weight: bold; margin-top: 5px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 25px 0; }
        .btn-durood { border: 2px solid #edf2f7; border-radius: 12px; padding: 20px 10px; cursor: pointer; transition: all 0.2s; background: white; font-weight: bold; color: var(--primary); }
        .btn-durood:hover { border-color: var(--accent); background: #f0fff4; color: var(--accent); }
        .btn-durood:active { transform: scale(0.95); }
        .btn-durood span { display: block; font-size: 1.2rem; margin-bottom: 5px; }
        .manual-input { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: center; gap: 10px; }
        input { padding: 10px; border: 2px solid #eee; border-radius: 8px; width: 80px; text-align: center; font-size: 1rem; outline: none; }
        input:focus { border-color: var(--accent); }
        button { padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:hover { background: #219150; }
    </style>
</head>
<body>

<div class="card">
    <div class="header-box">
        <div id="month-label">LOADING...</div>
        <div class="target-remaining">Target Remaining: <span id="remaining-target">0</span></div>
    </div>

    <div style="color: #94a3b8; font-size: 0.9rem; font-weight: 600;">TOTAL RECITATIONS</div>
    <div id="main-counter">0</div>

    <div class="grid">
        <div class="btn-durood" onclick="addCount(1)">
            <span>ðŸ“¿</span>
            Durood Ibrahim
        </div>
        <div class="btn-durood" onclick="addCount(1)">
            <span>âœ¨</span>
            Short Durood
        </div>
    </div>

    <div class="manual-input">
        <input type="number" id="manualNum" placeholder="Qty">
        <button onclick="addManual()">Submit</button>
    </div>
</div>

</body>
</html>
