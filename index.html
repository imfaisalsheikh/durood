<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faisal-Durood Counter</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAG0JD5hIk6w_zq1KNbm4HnXxajUxMk5l4",
            authDomain: "faisal-durood.firebaseapp.com",
            projectId: "faisal-durood",
            storageBucket: "faisal-durood.firebasestorage.app",
            messagingSenderId: "901424587968",
            appId: "1:901424587968:web:3fc0dea15c41f46f9af925",
            databaseURL: "https://faisal-durood-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const counterRef = ref(db, 'stats');

        function getCurrentMonthKey() {
            const now = new Date();
            return `${now.getFullYear()}-${now.getMonth() + 1}`;
        }

        function getMonthName() {
            return new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
        }

        function updateDisplay(data) {
            const currentTotal = data.total || 0;
            const monthlyTarget = data.monthlyTarget || 100000;
            const remaining = monthlyTarget - currentTotal;

            document.getElementById('main-counter').innerText = currentTotal.toLocaleString();
            document.getElementById('remaining-target').innerText = (remaining > 0 ? remaining : 0).toLocaleString();
            document.getElementById('month-label').innerText = getMonthName();
        }

        // Real-time synchronization
        onValue(counterRef, (snapshot) => {
            const data = snapshot.val();
            const currentMonthKey = getCurrentMonthKey();

            if (!data) {
                // First time setup
                set(counterRef, {
                    total: 0,
                    monthlyTarget: 100000,
                    monthKey: currentMonthKey
                });
            } else if (data.monthKey !== currentMonthKey) {
                // Monthly Rollover Logic
                const leftover = Math.max(0, (data.monthlyTarget || 100000) - (data.total || 0));
                set(counterRef, {
                    total: 0,
                    monthlyTarget: 100000 + leftover,
                    monthKey: currentMonthKey
                });
            } else {
                updateDisplay(data);
            }
        });

        window.addCount = function(amt) {
            runTransaction(ref(db, 'stats/total'), (current) => (current || 0) + amt);
        };

        window.addManual = function() {
            const val = parseInt(document.getElementById('manualNum').value);
            if (val > 0) {
                addCount(val);
                document.getElementById('manualNum').value = "";
            }
        };
    </script>
    <style>
        :root { --primary: #1a5e63; --accent: #27ae60; --bg: #f0f4f8; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; width: 100%; max-width: 400px; padding: 30px; border-radius: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center; }
        .header-box { background: #e0f2f1; padding: 15px; border-radius: 15px; margin-bottom: 25px; }
        #month-label { color: var(--primary); font-weight: bold; text-transform: uppercase; font-size: 0.8rem; }
        #main-counter { font-size: 5rem; color: #333; font-weight: 800; margin: 10px 0; line-height: 1; }
        .target-remaining { color: #c0392b; font-size: 1.2rem; font-weight: bold; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 30px 0; }
        .btn-durood { border: 2px solid #eee; border-radius: 15px; padding: 15px; cursor: pointer; transition: 0.2s; background: white; }
        .btn-durood:hover { border-color: var(--accent); background: #f9fffb; }
        .btn-durood:active { transform: scale(0.95); }
        .btn-durood img { width: 100%; height: auto; border-radius: 10px; margin-bottom: 10px; }
        .manual-input { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 10px; width: 100px; text-align: center; font-size: 1rem; }
        button { padding: 12px 20px; background: var(--accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-left: 5px; }
    </style>
</head>
<body>

<div class="card">
    <div class="header-box">
        <div id="month-label">Loading...</div>
        <div class="target-remaining">Target Left: <span id="remaining-target">0</span></div>
    </div>

    <div style="color: #7f8c8d; font-size: 0.9rem;">Total Recitations</div>
    <div id="main-counter">0</div>

    <div class="grid">
        <div class="btn-durood" onclick="addCount(1)">
            <img src="https://img.icons8.com/color/96/mosque.png" alt="Duroood">
            <strong>Durood 1</strong>
            <div><small>Click to +1</small></div>
        </div>
        <div class="btn-durood" onclick="addCount(1)">
            <img src="https://img.icons8.com/color/96/prow-bow.png" alt="Durood">
            <strong>Durood 2</strong>
            <div><small>Click to +1</small></div>
        </div>
    </div>

    <div class="manual-input">
        <input type="number" id="manualNum" placeholder="Amount">
        <button onclick="addManual()">Add</button>
    </div>
</div>

</body>
</html>
